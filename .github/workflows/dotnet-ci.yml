name: dotnet-ci

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore Framework Core
        run: dotnet restore Framework/Core/Core/Core.csproj

      - name: Restore Framework Cache
        run: dotnet restore Framework/Cache/Cache.csproj

      - name: Restore System Layer Projects
        run: |
          for project in sys-*/; do
            if [ -f "${project}"*.csproj ]; then
              echo "Restoring ${project}"
              dotnet restore "${project}"*.csproj
            fi
          done

      - name: Build Framework Core
        run: dotnet build Framework/Core/Core/Core.csproj --no-restore -c Release

      - name: Build Framework Cache
        run: dotnet build Framework/Cache/Cache.csproj --no-restore -c Release

      - name: Build System Layer Projects
        run: |
          for project in sys-*/; do
            if [ -f "${project}"*.csproj ]; then
              echo "Building ${project}"
              dotnet build "${project}"*.csproj --no-restore -c Release
            fi
          done

      - name: Test
        run: |
          for project in sys-*/; do
            if [ -f "${project}"*.csproj ]; then
              echo "Testing ${project}"
              dotnet test "${project}"*.csproj --no-build -c Release || echo "No tests found for ${project}"
            fi
          done
