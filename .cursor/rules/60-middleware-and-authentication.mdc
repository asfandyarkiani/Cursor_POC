---
description: "Middleware, MRI authentication patterns, and ordering"
globs:
  - Middlewares/**/*.cs
  - Attributes/**/*.cs
  - Functions/**/*.cs
  - Program.cs
alwaysApply: true
---

## 6. Middleware & Authentication

### MRI Authentication Middleware

####  DO:
- Mark Functions requiring MRI session with `[MRIAuthentication]` attribute
- Trust that middleware will authenticate and provide session ID
- Retrieve session ID from `context.Items[InfoConstants.SESSION_ID]` after middleware execution
- Let middleware handle logout automatically in `finally` block

####  DON'T:
- Manually authenticate/logout from MRI in Functions or Handlers
- Bypass middleware by implementing custom authentication logic
- Assume session exists when `[MRIAuthentication]` attribute is not present

### Middleware Registration

####  DO:
- Register middleware in `Program.cs` in correct order:
```csharp
builder.UseMiddleware<ExecutionTimingMiddleware>();
builder.UseMiddleware<ExceptionHandlerMiddleware>();
builder.UseMiddleware<MRIAuthenticationMiddleware>();
```

####  DON'T:
- Change middleware order without understanding implications
- Skip middleware registration
- Create new middleware without following existing patterns

---

