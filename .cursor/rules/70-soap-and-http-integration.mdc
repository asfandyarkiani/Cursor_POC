---
description: "SOAP envelopes, embedded resources, HTTP client usage, error handling"
globs:
  - SoapEnvelopes/**/*.xml
  - Helper/**/*.cs
  - Implementations/MRI/AtomicHandlers/**/*.cs
  - *.csproj
alwaysApply: true
---

## 7. SOAP / HTTP Integration

### SOAP Envelopes

####  DO:
- Store SOAP request templates as XML files in `SoapEnvelopes/` folder
- Register new SOAP envelopes as embedded resources in `FacilitiesMgmtSystem.csproj`:
```xml
<EmbeddedResource Include="SoapEnvelopes\NewOperation.xml" />
```
- Use `CustomSoapClient` for SOAP calls
- Use `SOAPHelper.DeserializeSoapResponse<T>()` for response deserialization
- Use `XMLHelper` for XML manipulation when needed

####  DON'T:
- Embed raw XML strings directly in C# code
- Create SOAP requests without using envelope templates
- Bypass existing helper utilities (`SOAPHelper`, `XMLHelper`, `CustomSoapClient`)

### HTTP Client Usage

####  DO:
- Use `CustomHTTPClient` for HTTP calls
- Leverage configured Polly retry/timeout policies via `IAsyncPolicy<HttpResponseMessage>`
- Handle HTTP errors appropriately (check status codes, deserialize error responses)

####  DON'T:
- Create new `HttpClient` instances directly (use `CustomHTTPClient`)
- Implement custom retry logic (use existing Polly policies)
- Ignore HTTP error status codes

### Error Handling for Downstream Calls

####  DO:
- Wrap downstream failures in appropriate exceptions:
  - `DownStreamApiFailureException` for API failures
  - `ApiException` for general API errors
- Log status codes and response details before throwing
- Include context in exception messages (file name, method name, operation)

####  DON'T:
- Throw generic `Exception` for downstream failures
- Swallow exceptions from downstream calls
- Return error responses without logging

---

